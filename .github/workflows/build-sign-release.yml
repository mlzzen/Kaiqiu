name: Build, Sign & Release

on:
  push:
    tags:
      - 'v*'

  # 生产版本: 发布 release 时触发
  release:
    types: [published]

env:
  APP_NAME: Kaiqiu
  JAVA_VERSION: 17

jobs:
  build:
    name: Build & Sign
    runs-on: ubuntu-latest

    outputs:
      version-name: ${{ steps.version.outputs.version-name }}
      is-release: ${{ steps.version.outputs.is-release }}

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 获取版本信息
      - name: Get version info
        id: version
        run: |
          # 从 gradle 获取版本名
          VERSION_NAME=$(grep -oP 'versionName\s*=\s*"\K[^"]+' app/build.gradle.kts || echo "1.0.0")
          VERSION_CODE=$(grep -oP 'versionCode\s*=\s*\K\d+' app/build.gradle.kts || echo "1")
          echo "version-name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version-code=$VERSION_CODE" >> $GITHUB_OUTPUT

          # 判断是否为 release 构建
          IS_RELEASE=false
          if [[ "${{ github.ref }}" == "refs/tags/v"* ]] || [[ "${{ github.event_name }}" == "release" ]]; then
            IS_RELEASE=true
          fi
          echo "is-release=$IS_RELEASE" >> $GITHUB_OUTPUT

          echo "版本名: $VERSION_NAME"
          echo "版本号: $VERSION_CODE"
          echo "Release 构建: $IS_RELEASE"

      # 3. 设置 Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      # 4. 设置 Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 36

      # 5. 生成 changelog
      - name: Generate changelog
        id: changelog
        if: steps.version.outputs.is-release == 'true'
        run: |
          # 获取上一个 tag 作为 changelog 起点
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD | cut -c1-7)
          fi

          echo "从 $PREV_TAG 生成 changelog..."

          # 生成 changelog
          git log $PREV_TAG..HEAD --oneline --reverse > CHANGELOG.txt

          echo "changelog generated"
          git log $PREV_TAG..HEAD --oneline --reverse

      # 6. 恢复签名密钥
      - name: Restore signing key
        if: steps.version.outputs.is-release == 'true'
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "KEYSTORE_BASE64 len: ${#KEYSTORE_BASE64}"
          echo "KEYSTORE_PASSWORD len: ${#KEYSTORE_PASSWORD}"
          echo "KEY_ALIAS len: ${#KEY_ALIAS}"
          echo "KEY_PASSWORD len: ${#KEY_PASSWORD}"
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "还原签名密钥..."
            echo "$KEYSTORE_BASE64" | base64 -d > app/keystore.jks
            {
              echo "KEYSTORE_PATH=app/keystore.jks"
              echo "KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD"
              echo "KEY_ALIAS=$KEY_ALIAS"
              echo "KEY_PASSWORD=$KEY_PASSWORD"
            } >> "$GITHUB_ENV"
            echo "密钥还原成功"
          else
            echo "警告: 未配置签名密钥，release 构建将跳过签名"
          fi

      # 7. 构建 Debug APK
      - name: Build Debug APK
        run: chmod +x gradlew && ./gradlew assembleDebug --no-daemon

      # 8. 构建 Release APK (如果配置了签名)
      - name: Build Release APK
        if: steps.version.outputs.is-release == 'true'
        run: chmod +x gradlew && ./gradlew assembleRelease --no-daemon

      # 9. 上传构建产物
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/

      - name: Upload Release APK
        if: steps.version.outputs.is-release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: app/build/outputs/apk/release/

      - name: Upload Changelog
        if: steps.version.outputs.is-release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.txt

  release:
    name: Create Release
    needs: build
    if: needs.build.outputs.is-release == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Download Debug APK
        uses: actions/download-artifact@v4
        with:
          name: debug-apk
          path: debug/

      - name: Download Release APK
        uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: release/

      - name: Download Changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog
          path: .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/app-release.apk
            debug/app-debug.apk
          body_path: CHANGELOG.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  upload-artifacts:
    name: Upload Artifacts (Development)
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.build.outputs.is-release != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Download Debug APK
        uses: actions/download-artifact@v4
        with:
          name: debug-apk
          path: debug/

      - name: Upload to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-debug-${{ github.sha }}
          path: debug/
          retention-days: 7
